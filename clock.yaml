esphome:
  name: clock
  friendly_name: Clock
  name_add_mac_suffix: True

esp8266:
  board: d1_mini

packages: !include common/base.yaml
api:
captive_portal:

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: True
  ap:
    ssid: Clock Fallback Hotspot

globals:
  - id: identify_active
    type: bool
    initial_value: 'false'

switch:
  - platform: template
    name: Night Mode
    id: night_mode
    icon: mdi:weather-night
    optimistic: True

font:
  - file: fonts/5x8.bdf
    id: font_large

time:
  - platform: sntp
    timezone: CET-1CEST,M3.5.0,M10.5.0/3
    id: source_time

spi:
  clk_pin: D6
  mosi_pin: D8

display:
  - platform: max7219digit
    id: max_display
    cs_pin: D7
    num_chips: 4
    update_interval: 20ms
    lambda: |-
      bool night = id(night_mode).state;
      it.intensity(night ? 0 : 15);
      if (id(identify_active)) {
        it.filled_rectangle(0, 0, 32, 8);
      } else {
        auto t = id(source_time).now();
        bool showColon = t.second % 2 == 0 || night;
        it.strftime(4, 0, id(font_large), showColon ? "%H:%M" : "%H %M", t);
      }

button:
  - platform: template
    name: Identify
    device_class: identify
    entity_category: diagnostic
    on_press:
      then:
        - globals.set:
            id: identify_active
            value: 'true'
        - delay: 5s
        - globals.set:
            id: identify_active
            value: 'false'
